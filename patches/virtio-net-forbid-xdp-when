Bottom: 7cbc22b9a89fe41103e6a61a52b7f9c71ef5ba43
Top:    949635f7c24027618e63c2aeb0dfbb87ef2cc520
Author: Jason Wang <jasowang@redhat.com>
Date:   2016-12-22 17:37:08 +0800

virtio-net: forbid XDP when GUEST_UFO is support

When VIRTIO_NET_F_GUEST_UFO is negotiated, host could still send large
UDP packet that exceeds a single page which could not be handled
correctly by XDP. So this patch forbid set XDP when GUEST_UFO is
supported.

Signed-off-by: Jason Wang <jasowang@redhat.com>


---

diff --git a/drivers/net/virtio_net.c b/drivers/net/virtio_net.c
index 08327e0..c316525 100644
--- a/drivers/net/virtio_net.c
+++ b/drivers/net/virtio_net.c
@@ -1678,7 +1678,8 @@ static int virtnet_xdp_set(struct net_device *dev, struct bpf_prog *prog)
 	int i, err;
 
 	if (virtio_has_feature(vi->vdev, VIRTIO_NET_F_GUEST_TSO4) ||
-	    virtio_has_feature(vi->vdev, VIRTIO_NET_F_GUEST_TSO6)) {
+	    virtio_has_feature(vi->vdev, VIRTIO_NET_F_GUEST_TSO6) ||
+	    virtio_has_feature(vi->vdev, VIRTIO_NET_F_GUEST_UFO))) {
 		netdev_warn(dev, "can't set XDP while host is implementing LRO, disable LRO first\n");
 		return -EOPNOTSUPP;
 	}
