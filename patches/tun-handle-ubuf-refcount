Bottom: ab85e594677bca3dc98f3ca256959bde3376d151
Top:    ab85e594677bca3dc98f3ca256959bde3376d151
Author: Jason Wang <jasowang@redhat.com>
Date:   2016-11-30 10:44:12 +0800

tun: handle ubuf refcount correctly when meet erros

We trigger uarg->callback() immediately after we decide do datacopy
even if caller want to do zerocopy. This will cause the callback
(vhost_net_zerocopy_callback) decrease the refcount. But when we meet
an error afterwards, the error handling in vhost handle_tx() will try
to decrease it again. This is wrong and fix this by delay the
uarg->callback() until we're sure there's no errors.

Signed-off-by: Jason Wang <jasowang@redhat.com>


---


