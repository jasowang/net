Bottom: 579b56b3b42598c5db664ef276979ce37b7c6416
Top:    579b56b3b42598c5db664ef276979ce37b7c6416
Author: Jason Wang <jasowang@redhat.com>
Date:   2016-05-18 16:27:57 +0800

tuntap: doing wakeup correctly during uninit

We used to check dev->reg_state against NETREG_REGISTERED after each
time we are woke up. But after commit 9e641bdcfa4e ("net-tun:
restructure tun_do_read for better sleep/wakeup efficiency"), it uses
skb_recv_datagram() which does not check dev->reg_state. This will
result if we delete a tun/tap device after a process is blocked in the
reading. The device will wait for an extra reference count which was
held by that process for ever.

Fixes this by using RCV_SHUTDOWN which will be checked during
sk_recv_datagram() before trying to wake up the process during uninit.

Fixes: 9e641bdcfa4e ("net-tun: restructure tun_do_read for better
sleep/wakeup efficiency")


---


